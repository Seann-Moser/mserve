const prefix = "{{.Name}}"

type Client struct {
	base        clientpkg.HttpClient
	headers     map[string]string
}

func Flags() *pflag.FlagSet {
	fs := pflag.NewFlagSet(prefix, pflag.ExitOnError)
	flags, err := clientpkg.Flags(prefix)
	if err != nil {
		return nil
	}
	fs.AddFlagSet(flags)
	{{range .Headers}}
	fs.String(clientpkg.GetFlagWithPrefix(prefix,"{{.}}"),"",strings.ToUpper(clientpkg.ToSnakeCase(clientpkg.GetFlagWithPrefix(prefix,"{{.}}")))){{end}}
	return fs
}

func New(httpClient *http.Client) (*Client, error) {
	b, err := clientpkg.NewWithFlags(prefix, httpClient)
	if err != nil {
		return nil, err
	}
	headers := map[string]string{}
	{{range .Headers}}headers["{{.}}"] = viper.GetString(clientpkg.GetFlagWithPrefix(prefix,"{{.}}"))
    {{end}}
	return &Client{
		base:       b,
		headers:    headers,
	}, nil
}


func (c *Client) EnableOauth(ctx context.Context) {
	c.base.AddOauthClient(prefix)
}

// Ping auto generated
func (c *Client) Ping(ctx context.Context) bool {
	requestDataInternal := clientpkg.NewRequestData("/healthcheck", http.MethodGet, nil, nil, clientpkg.MergeMap[string](nil, c.headers),false)
	resp := c.base.Request(ctx, requestDataInternal, nil,true)
	return resp.Status == http.StatusOK
}

func (c *Client) PingCheck(ctx context.Context) error {
	var valid bool
	tick := time.NewTicker(1 * time.Second)
	for i := 0; i < 30; i++ {
		select {
		case <-ctx.Done():
			return nil
		case <-tick.C:
			valid = c.Ping(ctx)
		}
		if valid {
			break
		}
	}
	if !valid {
		return fmt.Errorf("unable to reach endpoint")
	}
	return nil
}
